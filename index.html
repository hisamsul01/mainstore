<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“¦ Sistem Manajemen Stok</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-gray-100 flex min-h-screen transition-colors duration-500">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col space-y-4">
    <h1 class="text-2xl font-bold mb-6">ðŸ“¦ StokApp</h1>
    <button onclick="showPage('dashboard')" class="hover:bg-gray-700 p-2 rounded">Dashboard</button>
    <button onclick="showPage('master')" class="hover:bg-gray-700 p-2 rounded">Master Barang</button>
    <button onclick="showPage('masuk')" class="hover:bg-gray-700 p-2 rounded">Stok Masuk</button>
    <button onclick="showPage('keluar')" class="hover:bg-gray-700 p-2 rounded">Stok Keluar</button>
    <button onclick="showPage('rekap')" class="hover:bg-gray-700 p-2 rounded">Rekap Stok</button>
    <button onclick="showPage('mutasi')" class="hover:bg-gray-700 p-2 rounded">Mutasi Stok</button>
    <button onclick="showPage('laporan')" class="hover:bg-gray-700 p-2 rounded">Laporan</button>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">
    <!-- Navbar -->
    <nav class="flex justify-between items-center bg-white shadow px-6 py-3 sticky top-0 z-10">
      <h2 class="text-xl font-bold" id="page-title">Dashboard</h2>
      <div class="flex items-center gap-6">
        <div class="relative">
          <button onclick="toggleDropdown()" class="flex items-center gap-2 text-sm bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 transition">
            <i class="ph ph-gear"></i> Pengaturan
          </button>
          <div id="dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white border rounded shadow-lg">
            <button onclick="toggleTheme()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">ðŸŒ™ Mode Gelap/Terang</button>
            <button onclick="changeFont()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">ðŸ”¤ Ganti Font</button>
            <button onclick="refreshPage()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">ðŸ”„ Refresh</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Halaman Konten -->
    <main class="flex-1 p-6" id="main-content">
      <h3 class="text-lg">Selamat datang di Sistem Manajemen Stok</h3>
    </main>
  </div>

  <script>
    // === URL Spreadsheet Apps Script ===
    const scriptURL = "https://script.google.com/macros/s/AKfycbwKafiVSNguDis3pEQcW3U1-5J18FEAaMZ5_wTuUZ8XMxvzhj7XUsqxcwvjBMnuOcLz/exec";

    // === Navigasi Antar Halaman ===
    function showPage(page) {
      document.getElementById("page-title").innerText = page.charAt(0).toUpperCase() + page.slice(1);
      if (page === "rekap") loadRekap();
      if (page === "laporan") loadLaporan();
      if (page === "master") loadMaster();
      if (page === "masuk") loadFormMasuk();
      if (page === "keluar") loadFormKeluar();
      if (page === "mutasi") loadMutasi();
      if (page === "dashboard") loadDashboard();
    }

    // === Dropdown Pengaturan ===
    function toggleDropdown() {
      document.getElementById("dropdown").classList.toggle("hidden");
    }
    function toggleTheme() {
      document.body.classList.toggle("bg-gray-900");
      document.body.classList.toggle("text-white");
    }
    function changeFont() {
      document.body.style.fontFamily = document.body.style.fontFamily === "serif" ? "sans-serif" : "serif";
    }
    function refreshPage() { location.reload(); }

    // === Dashboard ===
    async function loadDashboard() {
      const res = await fetch(scriptURL);
      const data = await res.json();
      document.getElementById("main-content").innerHTML = `
        <div class="grid grid-cols-3 gap-4">
          <div class="p-4 bg-green-500 text-white rounded shadow">Barang Tersedia: ${data.length}</div>
          <div class="p-4 bg-yellow-500 text-white rounded shadow">Barang Hampir Habis: ${data.filter(x => x[6] <= 5).length}</div>
          <div class="p-4 bg-blue-500 text-white rounded shadow">Jumlah Store: 10</div>
        </div>
      `;
    }

    // === Rekap Stok ===
    async function loadRekap() {
      const res = await fetch(scriptURL);
      const data = await res.json();

      let html = `
        <div class='flex justify-between mb-4'>
          <div>
            <button onclick="exportExcel()" class='bg-green-500 text-white px-4 py-2 rounded mr-2'>Export Excel</button>
            <button onclick="exportPDF()" class='bg-yellow-500 text-white px-4 py-2 rounded'>Export PDF</button>
          </div>
          <input type='text' id='search' placeholder='Cari barang...' onkeyup='filterTable()' class='border px-3 py-2 rounded'>
        </div>
        <table id='rekap-table' class='table-auto w-full border'>
          <thead class='bg-gray-200'>
            <tr>
              <th class='border px-2 py-1'>Kode Barang</th>
              <th class='border px-2 py-1'>Nama Barang</th>
              <th class='border px-2 py-1'>Kategori</th>
              <th class='border px-2 py-1'>Stok Awal</th>
              <th class='border px-2 py-1'>Stok Masuk</th>
              <th class='border px-2 py-1'>Stok Keluar</th>
              <th class='border px-2 py-1'>Stok Akhir</th>
              <th class='border px-2 py-1'>Aksi</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(row => {
        html += `<tr>
          <td class='border px-2 py-1'>${row[0]}</td>
          <td class='border px-2 py-1'>${row[1]}</td>
          <td class='border px-2 py-1'>${row[2]}</td>
          <td class='border px-2 py-1'>${row[3]}</td>
          <td class='border px-2 py-1'>${row[4]}</td>
          <td class='border px-2 py-1'>${row[5]}</td>
          <td class='border px-2 py-1'>${row[6]}</td>
          <td class='border px-2 py-1'>
            <button class="bg-blue-500 text-white px-2 py-1 rounded" onclick="editBarang('${row[0]}')">Edit</button>
            <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="hapusBarang('${row[0]}')">Hapus</button>
          </td>
        </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById("main-content").innerHTML = html;
    }

    // === Laporan dengan Grafik ===
    async function loadLaporan() {
      const res = await fetch(scriptURL);
      const data = await res.json();
      document.getElementById("main-content").innerHTML = `<canvas id="laporanChart" height="100"></canvas>`;

      const ctx = document.getElementById("laporanChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map(x => x[1]),
          datasets: [
            { label: "Masuk", data: data.map(x => x[4]), backgroundColor: "green" },
            { label: "Keluar", data: data.map(x => x[5]), backgroundColor: "red" }
          ]
        }
      });
    }

    // === Export ===
    function exportExcel() {
      const wb = XLSX.utils.table_to_book(document.getElementById('rekap-table'));
      XLSX.writeFile(wb, 'RekapStok.xlsx');
    }
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Rekap Stok", 14, 16);
      doc.autoTable({ html: '#rekap-table' });
      doc.save('RekapStok.pdf');
    }

    // === Filter Cari Barang ===
    function filterTable() {
      const input = document.getElementById("search").value.toLowerCase();
      const rows = document.querySelectorAll("#rekap-table tbody tr");
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
      });
    }

    // === Placeholder fungsi form ===
    function loadMaster() { document.getElementById("main-content").innerHTML = "<p>Form Master Barang</p>"; }
    function loadFormMasuk() { document.getElementById("main-content").innerHTML = "<p>Form Stok Masuk</p>"; }
    function loadFormKeluar() { document.getElementById("main-content").innerHTML = "<p>Form Stok Keluar</p>"; }
    function loadMutasi() { document.getElementById("main-content").innerHTML = "<p>Mutasi Stok</p>"; }

    // === Edit / Hapus Barang ===
    function editBarang(kode) { alert("Edit barang: " + kode); }
    function hapusBarang(kode) { if (confirm("Hapus barang " + kode + "?")) alert("Barang dihapus"); }

  </script>
</body>
</html>
