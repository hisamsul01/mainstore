<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse Manager ‚Äî Google Sheets Integrated</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-blue-700 text-white p-4 space-y-4">
      <h1 class="text-2xl font-bold">üì¶ WMS</h1>
      <nav class="space-y-2">
        <button onclick="showPage('dashboard')" class="w-full text-left p-2 rounded hover:bg-blue-600">Dashboard</button>
        <button onclick="showPage('penerimaan')" class="w-full text-left p-2 rounded hover:bg-blue-600">Penerimaan Barang</button>
        <button onclick="showPage('transfer')" class="w-full text-left p-2 rounded hover:bg-blue-600">Transfer ke Outlet</button>
        <button onclick="showPage('master')" class="w-full text-left p-2 rounded hover:bg-blue-600">Master Barang</button>
        <button onclick="showPage('outlet')" class="w-full text-left p-2 rounded hover:bg-blue-600">Outlet</button>
        <button onclick="showPage('laporan')" class="w-full text-left p-2 rounded hover:bg-blue-600">Laporan</button>
        <button onclick="showPage('pengaturan')" class="w-full text-left p-2 rounded hover:bg-blue-600">Pengaturan</button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Dashboard -->
      <section id="dashboard" class="page">
        <h2 class="text-xl font-bold mb-4">üìä Dashboard</h2>
        <div id="summary" class="grid grid-cols-2 gap-4"></div>
      </section>

      <!-- Penerimaan Barang -->
      <section id="penerimaan" class="page hidden">
        <h2 class="text-xl font-bold mb-4">üì• Penerimaan Barang</h2>
        <form id="formPenerimaan" class="space-y-2">
          <input type="text" placeholder="Kode Barang" id="kodePenerimaan" class="p-2 border w-full" required>
          <input type="number" placeholder="Jumlah" id="qtyPenerimaan" class="p-2 border w-full" required>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button>
        </form>
      </section>

      <!-- Transfer Barang -->
      <section id="transfer" class="page hidden">
        <h2 class="text-xl font-bold mb-4">üöö Transfer Barang</h2>
        <form id="formTransfer" class="space-y-2">
          <input type="text" placeholder="Kode Barang" id="kodeTransfer" class="p-2 border w-full" required>
          <input type="number" placeholder="Jumlah" id="qtyTransfer" class="p-2 border w-full" required>
          <input type="text" placeholder="Outlet Tujuan" id="outletTransfer" class="p-2 border w-full" required>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button>
        </form>
      </section>

      <!-- Master Barang -->
      <section id="master" class="page hidden">
        <h2 class="text-xl font-bold mb-4">üìë Master Barang</h2>
        <form id="formMaster" class="space-y-2">
          <input type="text" placeholder="Kode Barang" id="kodeMaster" class="p-2 border w-full" required>
          <input type="text" placeholder="Nama Barang" id="namaMaster" class="p-2 border w-full" required>
          <input type="number" placeholder="Stok Awal" id="stokMaster" class="p-2 border w-full" required>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Tambah</button>
        </form>
        <table class="w-full mt-4 border" id="tabelMaster"></table>
      </section>

      <!-- Outlet -->
      <section id="outlet" class="page hidden">
        <h2 class="text-xl font-bold mb-4">üè¨ Outlet</h2>
        <form id="formOutlet" class="space-y-2">
          <input type="text" placeholder="Kode Outlet" id="kodeOutlet" class="p-2 border w-full" required>
          <input type="text" placeholder="Nama Outlet" id="namaOutlet" class="p-2 border w-full" required>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Tambah</button>
        </form>
        <table class="w-full mt-4 border" id="tabelOutlet"></table>
      </section>

      <!-- Laporan -->
      <section id="laporan" class="page hidden">
        <h2 class="text-xl font-bold mb-4">üìä Laporan</h2>
        <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded mb-2">Export CSV</button>
        <table class="w-full border" id="tabelLaporan"></table>
      </section>

      <!-- Pengaturan -->
      <section id="pengaturan" class="page hidden">
        <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Pengaturan</h2>
        <p>Tambah Admin, Tambah Store, Ubah Font, Tema, dsb.</p>
      </section>
    </main>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrEuroWXQ-EPgYTV_shis6rTepj6R5C2E8oijcaCMad40oD4Ce7reAcArXyVaskrJA/exec";

// ==== Utilities ====
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

async function fetchSheet(sheet) {
  const res = await fetch(`${SCRIPT_URL}?sheet=${sheet}`);
  return res.json();
}

async function appendRow(sheet, row) {
  return fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sheet, action: "append", row })
  }).then(r => r.json());
}

async function updateRow(sheet, rowIndex, row) {
  return fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sheet, action: "update", rowIndex, row })
  }).then(r => r.json());
}

async function deleteRow(sheet, rowIndex) {
  return fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sheet, action: "delete", rowIndex })
  }).then(r => r.json());
}

// ==== Forms ====

// Master Barang
const formMaster = document.getElementById('formMaster');
formMaster.addEventListener('submit', async e => {
  e.preventDefault();
  const row = [
    document.getElementById('kodeMaster').value,
    document.getElementById('namaMaster').value,
    document.getElementById('stokMaster').value
  ];
  await appendRow("MasterBarang", row);
  loadMaster();
  formMaster.reset();
});

async function loadMaster() {
  const data = await fetchSheet("MasterBarang");
  const table = document.getElementById('tabelMaster');
  table.innerHTML = "<tr><th>Kode</th><th>Nama</th><th>Stok</th><th>Aksi</th></tr>";
  data.data.slice(1).forEach((r, i) => {
    table.innerHTML += `<tr>
      <td>${r[0]}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>
        <button onclick="editMaster(${i+2}, '${r[0]}','${r[1]}','${r[2]}')" class='text-blue-600'>Edit</button>
        <button onclick="deleteRow('MasterBarang', ${i+2}).then(loadMaster)" class='text-red-600 ml-2'>Hapus</button>
      </td>
    </tr>`;
  });
}

function editMaster(rowIndex, kode, nama, stok) {
  document.getElementById('kodeMaster').value = kode;
  document.getElementById('namaMaster').value = nama;
  document.getElementById('stokMaster').value = stok;
  formMaster.onsubmit = async e => {
    e.preventDefault();
    const row = [
      document.getElementById('kodeMaster').value,
      document.getElementById('namaMaster').value,
      document.getElementById('stokMaster').value
    ];
    await updateRow("MasterBarang", rowIndex, row);
    formMaster.reset();
    formMaster.onsubmit = async e => {
      e.preventDefault();
      const row = [
        document.getElementById('kodeMaster').value,
        document.getElementById('namaMaster').value,
        document.getElementById('stokMaster').value
      ];
      await appendRow("MasterBarang", row);
      formMaster.reset();
      loadMaster();
    };
    loadMaster();
  };
}

// Outlet
const formOutlet = document.getElementById('formOutlet');
formOutlet.addEventListener('submit', async e => {
  e.preventDefault();
  const row = [
    document.getElementById('kodeOutlet').value,
    document.getElementById('namaOutlet').value
  ];
  await appendRow("Outlet", row);
  loadOutlet();
  formOutlet.reset();
});

async function loadOutlet() {
  const data = await fetchSheet("Outlet");
  const table = document.getElementById('tabelOutlet');
  table.innerHTML = "<tr><th>Kode</th><th>Nama</th><th>Aksi</th></tr>";
  data.data.slice(1).forEach((r, i) => {
    table.innerHTML += `<tr>
      <td>${r[0]}</td>
      <td>${r[1]}</td>
      <td>
        <button onclick="editOutlet(${i+2}, '${r[0]}','${r[1]}')" class='text-blue-600'>Edit</button>
        <button onclick="deleteRow('Outlet', ${i+2}).then(loadOutlet)" class='text-red-600 ml-2'>Hapus</button>
      </td>
    </tr>`;
  });
}

function editOutlet(rowIndex, kode, nama) {
  document.getElementById('kodeOutlet').value = kode;
  document.getElementById('namaOutlet').value = nama;
  formOutlet.onsubmit = async e => {
    e.preventDefault();
    const row = [
      document.getElementById('kodeOutlet').value,
      document.getElementById('namaOutlet').value
    ];
    await updateRow("Outlet", rowIndex, row);
    formOutlet.reset();
    formOutlet.onsubmit = async e => {
      e.preventDefault();
      const row = [
        document.getElementById('kodeOutlet').value,
        document.getElementById('namaOutlet').value
      ];
      await appendRow("Outlet", row);
      formOutlet.reset();
      loadOutlet();
    };
    loadOutlet();
  };
}

// Penerimaan
const formPenerimaan = document.getElementById('formPenerimaan');
formPenerimaan.addEventListener('submit', async e => {
  e.preventDefault();
  const row = [
    document.getElementById('kodePenerimaan').value,
    document.getElementById('qtyPenerimaan').value,
    new Date().toLocaleString()
  ];
  await appendRow("Penerimaan", row);
  formPenerimaan.reset();
});

// Transfer
const formTransfer = document.getElementById('formTransfer');
formTransfer.addEventListener('submit', async e => {
  e.preventDefault();
  const row = [
    document.getElementById('kodeTransfer').value,
    document.getElementById('qtyTransfer').value,
    document.getElementById('outletTransfer').value,
    new Date().toLocaleString()
  ];
  await appendRow("Transfer", row);
  formTransfer.reset();
});

// Laporan
async function loadLaporan() {
  const penerimaan = await fetchSheet("Penerimaan");
  const transfer = await fetchSheet("Transfer");
  const table = document.getElementById('tabelLaporan');
  table.innerHTML = "<tr><th>Tipe</th><th>Kode</th><th>Qty</th><th>Outlet</th><th>Tanggal</th></tr>";
  penerimaan.data.slice(1).forEach(r => {
    table.innerHTML += `<tr><td>Penerimaan</td><td>${r[0]}</td><td>${r[1]}</td><td>-</td><td>${r[2]}</td></tr>`;
  });
  transfer.data.slice(1).forEach(r => {
    table.innerHTML += `<tr><td>Transfer</td><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`;
  });
}

function exportCSV() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(document.getElementById('tabelLaporan'));
  XLSX.utils.book_append_sheet(wb, ws, "Laporan");
  XLSX.writeFile(wb, "laporan.xlsx");
}

// Init
loadMaster();
loadOutlet();
loadLaporan();
</script>
</body>
</html>
