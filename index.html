<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Warehouse Manager</title>
<style>
  :root{
    --primary:#4e73df;--primary-2:#2e59d9;--bg:#f8f9fa;--ink:#343a40;
    --card:#ffffff;--muted:#6c757d;--ok:#1cc88a;--warn:#f6c23e;--danger:#e74a3b;
    --shadow:0 6px 18px rgba(0,0,0,.06)
  }
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  a{text-decoration:none;color:inherit}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 18px;background:#fff;box-shadow:var(--shadow)}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--primary)}
  .brand .logo{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#7c9af5)}
  .top-actions{display:flex;gap:8px;align-items:center}
  .btn,button,input,select{font:inherit}
  .btn{border:0;border-radius:8px;padding:8px 12px;background:var(--primary);color:#fff;cursor:pointer}
  .btn.secondary{background:var(--ink);color:#fff;opacity:.85}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
  .lang-select, .user-input{border:1px solid #dee2e6;border-radius:8px;padding:7px 10px;background:#fff}

  /* Layout */
  .wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 62px)}
  .sidebar{background:#1f2a48;color:#e9ecff;padding:16px 12px}
  .sidebar h6{margin:18px 8px 8px;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#92a1d1}
  .nav{list-style:none;padding:0;margin:0}
  .nav li{margin:6px 0}
  .nav a{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px 12px;border-radius:8px;color:#e9ecff}
  .nav a:hover,.nav a.active{background:#2a3870}
  .submenu{display:none;padding-left:10px}
  .nav li.open>.submenu{display:block;animation:fade .2s}
  @keyframes fade{from{opacity:.3;transform:translateY(-2px)}to{opacity:1;transform:none}}

  .content{padding:22px}
  .cards{display:grid;grid-template-columns:repeat(6,minmax(140px,1fr));gap:14px;margin-bottom:18px}
  .card{background:var(--card);border-radius:12px;padding:14px 16px;box-shadow:var(--shadow)}
  .card .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .card .value{font-weight:800;color:var(--primary);font-size:24px}
  .card.badge-ok .value{color:var(--ok)}.card.badge-warn .value{color:var(--warn)}.card.badge-danger .value{color:var(--danger)}

  .panel{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:16px;margin-bottom:18px}
  .panel h3{margin:0 0 12px;font-size:18px;color:var(--primary)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1}
  .field input,.field select,.field textarea{padding:9px 11px;border:1px solid #ced4da;border-radius:10px;background:#fff}
  .table-wrap{overflow:auto;border:1px solid #e9ecef;border-radius:10px}
  table{border-collapse:collapse;width:100%;min-width:820px}
  thead th{position:sticky;top:0;background:#f4f6ff;color:var(--primary);text-align:left;font-weight:700;padding:10px;border-bottom:1px solid #e9ecef}
  tbody td{padding:10px;border-bottom:1px solid #f1f3f5}
  tr:hover{background:#f8fbff}
  .badge{display:inline-block;min-width:34px;text-align:center;padding:3px 8px;border-radius:999px;color:#fff;font-weight:700;font-size:12px}
  .b-ok{background:var(--ok)}.b-warn{background:var(--warn)}.b-danger{background:var(--danger)}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}

  /* Utility */
  .hidden{display:none !important}
  .right{margin-left:auto}

  /* Responsive */
  @media (max-width: 990px){
    .wrap{grid-template-columns:1fr}
    .sidebar{position:fixed;inset:62px 0 0 auto;width:260px;transform:translateX(-100%);transition:.25s}
    .sidebar.show{transform:none}
    .content{padding:18px}
    .cards{grid-template-columns:repeat(2,1fr)}
    .grid-2{grid-template-columns:1fr}
  }

  /* Print (for PDF) */
  @media print{
    .topbar,.sidebar,.tools,.cards{display:none !important}
    .content{padding:0}
    .panel{box-shadow:none;border:0;margin:0 0 10px}
    table{min-width:0}
  }
</style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand"><div class="logo"></div><div>Warehouse Manager</div></div>
    <div class="top-actions">
      <button class="btn ghost" id="toggleSidebarBtn">â˜°</button>
      <select id="lang" class="lang-select" title="Language">
        <option value="id">Bahasa Indonesia</option>
        <option value="en">English</option>
      </select>
      <span id="currentUser" class="muted"></span>
    </div>
  </header>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <h6 data-i="nav">Navigasi</h6>
      <ul class="nav" id="nav">
        <li><a href="#dashboard" class="active" data-view="dashboard" data-i="menu_dashboard">Dashboard</a></li>

        <li class="has-sub">
          <a class="with-caret" data-toggle="submenu" data-i="menu_opsi">Operasional <span>â–¾</span></a>
          <ul class="submenu">
            <li><a href="#receipt" data-view="receipt" data-i="menu_receipt">Penerimaan Barang</a></li>
            <li><a href="#transfer" data-view="transfer" data-i="menu_transfer">Transfer ke Outlet</a></li>
          </ul>
        </li>

        <li class="has-sub">
          <a class="with-caret" data-toggle="submenu" data-i="menu_master">Master Data <span>â–¾</span></a>
          <ul class="submenu">
            <li><a href="#outlets" data-view="outlets" data-i="menu_outlet">Outlet</a></li>
          </ul>
        </li>

        <li><a href="#reports" data-view="reports" data-i="menu_reports">Laporan</a></li>
        <li><a href="#settings" data-view="settings" data-i="menu_settings">Pengaturan</a></li>
      </ul>

      <div class="muted" style="margin:18px 8px 8px;">Â© <span id="year"></span> Warehouse</div>
    </aside>

    <!-- Main -->
    <main class="content">

      <!-- DASHBOARD -->
      <section id="view-dashboard">
        <div class="cards" id="widgets">
          <div class="card"><div class="label" data-i="w_items">Jenis Barang</div><div class="value" id="wItems">0</div></div>
          <div class="card badge-ok"><div class="label" data-i="w_stock">Total Stok</div><div class="value" id="wStock">0</div></div>
          <div class="card badge-warn"><div class="label" data-i="w_receipts">Penerimaan</div><div class="value" id="wReceipts">0</div></div>
          <div class="card badge-danger"><div class="label" data-i="w_transfers">Transfer</div><div class="value" id="wTransfers">0</div></div>
          <div class="card"><div class="label" data-i="w_outlets">Outlet</div><div class="value" id="wOutlets">0</div></div>
          <div class="card"><div class="label" data-i="w_users">Pengguna</div><div class="value" id="wUsers">1</div></div>
        </div>

        <div class="panel">
          <h3 data-i="quick_actions">Aksi Cepat</h3>
          <div class="tools">
            <button class="btn" onclick="showView('receipt')"><span data-i="menu_receipt">Penerimaan Barang</span></button>
            <button class="btn" onclick="showView('transfer')"><span data-i="menu_transfer">Transfer ke Outlet</span></button>
            <button class="btn ghost" onclick="showView('reports')"><span data-i="menu_reports">Laporan</span></button>
          </div>
        </div>
      </section>

      <!-- PENERIMAAN BARANG -->
      <section id="view-receipt" class="hidden">
        <div class="panel">
          <h3 data-i="receipt_title">Penerimaan Barang</h3>
          <div class="grid-2">
            <div class="field"><label data-i="code">Kode Barang</label><input id="rcpCode" placeholder="BRG-001"></div>
            <div class="field"><label data-i="name">Nama Barang</label><input id="rcpName" placeholder="Cat Tembok 10L"></div>
            <div class="field"><label data-i="qty">Kuantitas</label><input id="rcpQty" type="number" min="1" value="1"></div>
            <div class="field"><label>&nbsp;</label><button class="btn" onclick="addReceipt()" data-i="add">Tambah</button></div>
          </div>
        </div>

        <div class="panel">
          <h3 data-i="inventory">Inventori</h3>
          <div class="table-wrap">
            <table id="tblInventory">
              <thead><tr>
                <th data-i="code">Kode</th><th data-i="name">Nama</th><th data-i="qty">Qty</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- TRANSFER KE OUTLET -->
      <section id="view-transfer" class="hidden">
        <div class="panel">
          <h3 data-i="transfer_title">Transfer Barang ke Outlet</h3>
          <div class="grid-2">
            <div class="field"><label data-i="code">Kode Barang</label><input id="trfCode" placeholder="BRG-001"></div>
            <div class="field"><label data-i="name">Nama Barang</label><input id="trfName" placeholder="Cat Tembok 10L"></div>
            <div class="field"><label data-i="qty">Kuantitas</label><input id="trfQty" type="number" min="1" value="1"></div>
            <div class="field"><label data-i="outlet">Outlet</label>
              <select id="trfOutlet"></select>
            </div>
            <div class="field"><label>&nbsp;</label><button class="btn" onclick="addTransfer()" data-i="transfer_btn">Transfer</button></div>
          </div>
          <div class="muted" id="trfHint"></div>
        </div>
      </section>

      <!-- OUTLET CRUD -->
      <section id="view-outlets" class="hidden">
        <div class="panel">
          <h3 data-i="outlet_title">Outlet</h3>
          <div class="row" style="margin-bottom:10px">
            <div class="field"><label data-i="outlet_code">Kode Outlet</label><input id="outCode" placeholder="OT-01"></div>
            <div class="field"><label data-i="outlet_name">Nama Outlet</label><input id="outName" placeholder="Outlet Utama"></div>
            <div class="field"><label>&nbsp;</label><button class="btn" onclick="addOutlet()" data-i="add">Tambah</button></div>
          </div>

          <div class="table-wrap">
            <table id="tblOutlets">
              <thead><tr>
                <th data-i="outlet_code">Kode</th><th data-i="outlet_name">Nama</th><th>Aksi</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section id="view-reports" class="hidden">
        <div class="panel">
          <h3 data-i="report_title">Laporan Transaksi</h3>
          <div class="row" style="margin-bottom:10px">
            <div class="field"><label data-i="type">Jenis</label>
              <select id="repType">
                <option value="all" data-i="all">Semua</option>
                <option value="receipt" data-i="menu_receipt">Penerimaan</option>
                <option value="transfer" data-i="menu_transfer">Transfer</option>
              </select>
            </div>
            <div class="field"><label data-i="search">Pencarian</label><input id="repSearch" placeholder="Cari kode/nama/outlet"></div>
            <div class="tools right">
              <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
              <button class="btn" onclick="window.print()">Print to PDF</button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="tblReports">
              <thead><tr>
                <th data-i="date">Tanggal</th>
                <th data-i="type">Jenis</th>
                <th data-i="code">Kode</th>
                <th data-i="name">Nama</th>
                <th data-i="qty">Qty</th>
                <th data-i="outlet">Outlet</th>
                <th data-i="note">Keterangan</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="panel" style="margin-top:14px">
            <h3 data-i="expense_title">Ringkasan Pengeluaran ke Outlet</h3>
            <div class="table-wrap">
              <table id="tblExpenses">
                <thead><tr>
                  <th data-i="outlet">Outlet</th>
                  <th data-i="qty">Total Qty</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="hidden">
        <div class="panel">
          <h3 data-i="settings_title">Pengaturan</h3>
          <div class="grid-2">
            <div class="field"><label data-i="username">Username</label><input id="setUser" class="user-input"></div>
            <div class="field"><label data-i="password">Password</label><input id="setPass" type="password" class="user-input"></div>
            <div class="field row" style="align-items:center">
              <input id="setWidgets" type="checkbox" checked style="width:18px;height:18px">
              <label for="setWidgets" data-i="show_widgets" style="margin-left:6px">Tampilkan Widget Dashboard</label>
            </div>
            <div class="field"><button class="btn" onclick="saveSettings()" data-i="save">Simpan</button></div>
          </div>
          <div id="saveNote" class="muted" style="margin-top:10px"></div>
        </div>
      </section>

    </main>
  </div>

<script>
/* ---------- Data Layer (localStorage) ---------- */
const DB = {
  key: 'whm.v1',
  init(){
    if(!localStorage.getItem(this.key)){
      const seed = {
        user:{username:'admin', password:'admin', showWidgets:true, lang:'id'},
        outlets:[{code:'OT-01', name:'Outlet Utama'}],
        inventory:[],             // {code,name,qty}
        receipts:[],              // {date, code, name, qty, note}
        transfers:[]              // {date, code, name, qty, outlet, note}
      };
      localStorage.setItem(this.key, JSON.stringify(seed));
    }
  },
  load(){ return JSON.parse(localStorage.getItem(this.key)); },
  save(data){ localStorage.setItem(this.key, JSON.stringify(data)); }
};
DB.init();

/* ---------- i18n ---------- */
const I18N = {
  en:{
    nav:'Navigation',
    menu_dashboard:'Dashboard', menu_opsi:'Operations', menu_master:'Master Data',
    menu_receipt:'Goods Receipt', menu_transfer:'Transfer to Outlet', menu_outlet:'Outlets',
    menu_reports:'Reports', menu_settings:'Settings',
    w_items:'Item Types', w_stock:'Total Stock', w_receipts:'Receipts', w_transfers:'Transfers', w_outlets:'Outlets', w_users:'Users',
    quick_actions:'Quick Actions',
    receipt_title:'Goods Receipt', code:'Item Code', name:'Item Name', qty:'Quantity', add:'Add',
    inventory:'Inventory',
    transfer_title:'Transfer to Outlet', outlet:'Outlet', transfer_btn:'Transfer',
    outlet_title:'Outlets', outlet_code:'Outlet Code', outlet_name:'Outlet Name',
    report_title:'Transaction History', search:'Search', type:'Type', all:'All',
    date:'Date', note:'Note', expense_title:'Expense Summary to Outlet',
    settings_title:'Settings', username:'Username', password:'Password', show_widgets:'Show Dashboard Widgets', save:'Save',
  },
  id:{
    nav:'Navigasi',
    menu_dashboard:'Dashboard', menu_opsi:'Operasional', menu_master:'Master Data',
    menu_receipt:'Penerimaan Barang', menu_transfer:'Transfer ke Outlet', menu_outlet:'Outlet',
    menu_reports:'Laporan', menu_settings:'Pengaturan',
    w_items:'Jenis Barang', w_stock:'Total Stok', w_receipts:'Penerimaan', w_transfers:'Transfer', w_outlets:'Outlet', w_users:'Pengguna',
    quick_actions:'Aksi Cepat',
    receipt_title:'Penerimaan Barang', code:'Kode Barang', name:'Nama Barang', qty:'Kuantitas', add:'Tambah',
    inventory:'Inventori',
    transfer_title:'Transfer Barang ke Outlet', outlet:'Outlet', transfer_btn:'Transfer',
    outlet_title:'Outlet', outlet_code:'Kode Outlet', outlet_name:'Nama Outlet',
    report_title:'Laporan Transaksi', search:'Pencarian', type:'Jenis', all:'Semua',
    date:'Tanggal', note:'Keterangan', expense_title:'Ringkasan Pengeluaran ke Outlet',
    settings_title:'Pengaturan', username:'Username', password:'Password', show_widgets:'Tampilkan Widget Dashboard', save:'Simpan',
  }
};
function applyLang(lang){
  const dict = I18N[lang] || I18N.id;
  document.querySelectorAll('[data-i]').forEach(el=>{
    const key = el.getAttribute('data-i');
    if(dict[key]) el.textContent = dict[key];
  });
  document.documentElement.lang = lang;
  const db = DB.load(); db.user.lang = lang; DB.save(db);
}

/* ---------- Navigation & Views ---------- */
const views = ['dashboard','receipt','transfer','outlets','reports','settings'];
function showView(name){
  views.forEach(v=>{
    document.getElementById('view-'+v).classList.toggle('hidden', v!==name);
    document.querySelectorAll(`[data-view="${v}"]`).forEach(a=>a.classList.toggle('active', v===name));
  });
  if(name==='reports'){ renderReports(); renderExpenses(); }
  if(name==='outlets'){ renderOutlets(); }
  if(name==='receipt'){ renderInventory(); }
  if(name==='transfer'){ populateOutletSelect(); }
  if(name==='dashboard'){ refreshWidgets(); }
  location.hash = name;
}
document.getElementById('nav').addEventListener('click', (e)=>{
  const a = e.target.closest('a[data-view]');
  if(a){ e.preventDefault(); showView(a.dataset.view); }
});
document.querySelectorAll('[data-toggle="submenu"]').forEach(a=>{
  a.addEventListener('click', ()=> a.parentElement.classList.toggle('open'));
});
document.getElementById('toggleSidebarBtn').onclick = ()=>{
  document.getElementById('sidebar').classList.toggle('show');
};

/* ---------- Inventory Ops ---------- */
function addReceipt(){
  const code = val('rcpCode'), name = val('rcpName'), qty = +val('rcpQty')||0;
  if(!code||!name||qty<=0) return alert('Lengkapi data penerimaan.');
  const db = DB.load();
  const item = db.inventory.find(i=>i.code===code) || {code,name,qty:0};
  item.name = name; item.qty += qty;
  if(!db.inventory.some(i=>i.code===code)) db.inventory.push(item);
  db.receipts.push({date:new Date().toISOString(), code,name,qty, note:'Receipt'});
  DB.save(db);
  clear('rcpQty'); renderInventory(); refreshWidgets();
  alert('Penerimaan tersimpan.');
}
function renderInventory(){
  const tbody = sel('#tblInventory tbody'); tbody.innerHTML='';
  const {inventory} = DB.load();
  inventory.forEach(i=>{
    const badge = i.qty<=5?'b-danger':(i.qty<15?'b-warn':'b-ok');
    tr(tbody,[i.code,i.name,`<span class="badge ${badge}">${i.qty}</span>`]);
  });
}

/* ---------- Transfer Ops ---------- */
function populateOutletSelect(){
  const db = DB.load(); const s = document.getElementById('trfOutlet'); s.innerHTML='';
  db.outlets.forEach(o=>{
    const opt = document.createElement('option'); opt.value=o.code; opt.textContent=`${o.code} â€” ${o.name}`; s.appendChild(opt);
  });
  document.getElementById('trfHint').textContent = db.outlets.length? '' : 'Belum ada outlet. Tambahkan dulu di menu Outlet.';
}
function addTransfer(){
  const code = val('trfCode'), name = val('trfName'), qty = +val('trfQty')||0, outlet = document.getElementById('trfOutlet').value;
  if(!code||!name||qty<=0||!outlet) return alert('Lengkapi data transfer.');
  const db = DB.load();
  const item = db.inventory.find(i=>i.code===code);
  if(!item || item.qty<qty) return alert('Stok tidak cukup / barang belum ada.');
  item.name = name; item.qty -= qty;
  db.transfers.push({date:new Date().toISOString(), code,name,qty,outlet, note:'Transfer'});
  DB.save(db);
  clear('trfQty'); renderInventory(); refreshWidgets();
  alert('Transfer tersimpan.');
}

/* ---------- Outlet CRUD ---------- */
function addOutlet(){
  const code = val('outCode'), name = val('outName');
  if(!code||!name) return alert('Kode/Nama outlet wajib.');
  const db = DB.load();
  if(db.outlets.some(o=>o.code===code)) return alert('Kode outlet sudah ada.');
  db.outlets.push({code,name}); DB.save(db);
  clear('outCode'); clear('outName'); renderOutlets(); populateOutletSelect(); refreshWidgets();
}
function editOutlet(code){
  const name = prompt('Ubah nama outlet:');
  if(name===null) return;
  const db = DB.load(); const o = db.outlets.find(x=>x.code===code); if(!o) return;
  o.name = name || o.name; DB.save(db); renderOutlets(); populateOutletSelect();
}
function deleteOutlet(code){
  if(!confirm('Hapus outlet ini?')) return;
  const db = DB.load(); db.outlets = db.outlets.filter(o=>o.code!==code); DB.save(db);
  renderOutlets(); populateOutletSelect(); refreshWidgets();
}
function renderOutlets(){
  const tbody = sel('#tblOutlets tbody'); tbody.innerHTML='';
  DB.load().outlets.forEach(o=>{
    tr(tbody,[
      o.code,o.name,
      `<div class="tools">
         <button class="btn ghost" onclick="editOutlet('${o.code}')">Edit</button>
         <button class="btn secondary" onclick="deleteOutlet('${o.code}')">Delete</button>
       </div>`
    ]);
  });
}

/* ---------- Reports ---------- */
function renderReports(){
  const tbody = sel('#tblReports tbody'); tbody.innerHTML='';
  const {receipts, transfers} = DB.load();
  let rows = [
    ...receipts.map(r=>({...r,type:'receipt'})),
    ...transfers.map(t=>({...t,type:'transfer'}))
  ].sort((a,b)=> new Date(b.date)-new Date(a.date));

  // filter
  const tp = val('repType'); const q = val('repSearch').toLowerCase();
  if(tp!=='all') rows = rows.filter(r=>r.type===tp);
  if(q) rows = rows.filter(r=>(r.code+r.name+(r.outlet||'')).toLowerCase().includes(q));

  rows.forEach(r=>{
    tr(tbody,[
      fmtDate(r.date),
      r.type==='receipt' ? txt('menu_receipt') : txt('menu_transfer'),
      r.code, r.name, r.qty, (r.outlet||'-'), (r.note||'-')
    ]);
  });
}
function renderExpenses(){
  const tbody = sel('#tblExpenses tbody'); tbody.innerHTML='';
  const {transfers,outlets} = DB.load();
  const agg = {};
  transfers.forEach(t=>{ agg[t.outlet] = (agg[t.outlet]||0) + Number(t.qty); });
  (outlets||[]).forEach(o=>{
    tr(tbody,[`${o.code} â€” ${o.name}`, agg[o.code]||0]);
  });
}
function exportCSV(){
  // Build CSV from report table
  const headers = Array.from(sel('#tblReports thead tr').children).map(th=>th.textContent.trim());
  const lines = [headers.join(',')];
  Array.from(sel('#tblReports tbody').children).forEach(trEl=>{
    const cols = Array.from(trEl.children).map(td=>escapeCSV(td.textContent.trim()));
    lines.push(cols.join(','));
  });
  const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download='transactions.csv'; a.click(); URL.revokeObjectURL(url);
}
function escapeCSV(s){ return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

/* ---------- Settings ---------- */
function saveSettings(){
  const db = DB.load();
  const u = val('setUser').trim(); const p = val('setPass').trim();
  if(u) db.user.username = u;
  if(p) db.user.password = p; // (untuk demo; produksi -> hash)
  db.user.showWidgets = sel('#setWidgets').checked;
  DB.save(db);
  sel('#widgets').style.display = db.user.showWidgets ? '' : 'none';
  sel('#saveNote').textContent = 'Pengaturan disimpan.';
  refreshUser();
}

/* ---------- Helpers & UI Refresh ---------- */
function refreshWidgets(){
  const db = DB.load();
  sel('#wItems').textContent = db.inventory.length;
  sel('#wStock').textContent = db.inventory.reduce((a,b)=>a + Number(b.qty||0),0);
  sel('#wReceipts').textContent = db.receipts.length;
  sel('#wTransfers').textContent = db.transfers.length;
  sel('#wOutlets').textContent = db.outlets.length;
}
function refreshUser(){
  const {user} = DB.load();
  sel('#currentUser').textContent = `ðŸ‘¤ ${user.username}`;
  sel('#widgets').style.display = user.showWidgets ? '' : 'none';
  sel('#lang').value = user.lang || 'id';
}
function populateAll(){
  refreshWidgets(); renderInventory(); renderOutlets(); populateOutletSelect(); renderReports(); renderExpenses(); refreshUser();
  applyLang(DB.load().user.lang || 'id');
}
function fmtDate(iso){ const d = new Date(iso); return d.toLocaleString(); }
function val(id){ return document.getElementById(id).value; }
function clear(id){ document.getElementById(id).value=''; }
function sel(q){ return document.querySelector(q); }
function tr(tbody, cells){
  const tr = document.createElement('tr');
  cells.forEach(c=>{
    const td = document.createElement('td'); td.innerHTML = c; tr.appendChild(td);
  });
  tbody.appendChild(tr);
}
function txt(key){ const lang = DB.load().user.lang||'id'; return (I18N[lang]||{})[key] || key; }

/* ---------- Events ---------- */
document.getElementById('lang').addEventListener('change', e=>applyLang(e.target.value));
document.getElementById('repType').addEventListener('change', renderReports);
document.getElementById('repSearch').addEventListener('input', renderReports);
window.addEventListener('hashchange', ()=>{
  const name = location.hash.replace('#','') || 'dashboard';
  if(views.includes(name)) showView(name);
});
document.getElementById('year').textContent = new Date().getFullYear();

/* ---------- Boot ---------- */
populateAll();
showView((location.hash||'#dashboard').replace('#',''));

/* Seed demo data on first run (optional) */
(function seedDemo(){
  const db = DB.load();
  if(db.receipts.length===0 && db.inventory.length===0){
    db.receipts.push(
      {date:new Date(Date.now()-86400000*2).toISOString(),code:'BRG-001',name:'Cat Tembok 10L',qty:12,note:'Receipt'},
      {date:new Date(Date.now()-86400000).toISOString(),code:'BRG-002',name:'Amplas 400',qty:30,note:'Receipt'}
    );
    db.inventory.push({code:'BRG-001',name:'Cat Tembok 10L',qty:12},{code:'BRG-002',name:'Amplas 400',qty:30});
    db.transfers.push({date:new Date().toISOString(),code:'BRG-002',name:'Amplas 400',qty:5,outlet:'OT-01',note:'Transfer'});
    DB.save(db);
    populateAll();
  }
})();
</script>
</body>
</html>