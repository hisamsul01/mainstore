<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Warehouse Manager â€” Single File</title>
<style>
  :root{
    --primary:#4e73df; --ok:#1cc88a; --warn:#f6c23e; --danger:#e74a3b;
    --bg:#f6f7fb; --card:#fff; --muted:#64748b; --radius:12px; --shadow:0 8px 20px rgba(2,6,23,0.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#0f1724}
  a{color:inherit;text-decoration:none}
  /* Topbar */
  .topbar{position:sticky;top:0;z-index:60;background:#fff;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eef2f6}
  .brand{display:flex;gap:10px;align-items:center;color:var(--primary);font-weight:800}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{border:0;padding:8px 12px;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--primary);color:var(--primary)}
  .control{padding:7px 10px;border-radius:8px;border:1px solid #e6eefc;background:#fff}

  /* Sidebar */
  .sidebar{position:fixed;left:-260px;top:64px;bottom:0;width:260px;background:#13203d;color:#eaf0ff;padding:18px;transition:left .28s ease;z-index:70;overflow:auto}
  .sidebar.show{left:0}
  .nav h6{font-size:12px;color:#94b0ff;margin:12px 0;text-transform:uppercase;letter-spacing:.08em}
  .nav ul{list-style:none;padding:0;margin:0}
  .nav li{margin-bottom:6px}
  .nav a{display:block;padding:10px;border-radius:8px;color:rgba(234,240,255,0.95)}
  .nav a:hover,.nav a.active{background:#20355f}
  .submenu{display:none;padding-left:12px;margin-top:6px}
  .open>.submenu{display:block}

  /* main */
  .main{transition:margin-left .28s ease;padding:18px}
  .sidebar.show ~ .main{margin-left:260px}
  @media(min-width:900px){ .sidebar{left:0} .main{margin-left:260px} .menu-toggle{display:none} }

  /* UI */
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
  .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .label{color:var(--muted);font-size:13px}
  .card .value{font-weight:800;color:var(--primary);font-size:20px}

  .panel{background:var(--card);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
  .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:780px){ .cards{grid-template-columns:repeat(4,1fr)} .grid-2{grid-template-columns:1fr 1fr} }
  .field{display:flex;flex-direction:column;gap:6px}
  input,select,textarea{padding:9px;border-radius:8px;border:1px solid #e6eefc;background:#fff}

  .table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef2f6}
  table{width:100%;border-collapse:collapse;min-width:720px}
  thead th{background:#fbfdff;color:var(--primary);padding:10px;text-align:left;position:sticky;top:0}
  tbody td{padding:10px;border-bottom:1px solid #f3f6fb}
  tbody tr:hover{background:#f7fbff}

  .badge{display:inline-block;padding:5px 10px;border-radius:999px;color:#fff;font-weight:700}
  .b-ok{background:var(--ok)}.b-warn{background:var(--warn)}.b-danger{background:var(--danger)}

  .tools{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .hidden{display:none!important}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:90}
  .modal{background:#fff;padding:14px;border-radius:10px;max-width:720px;width:92%;box-shadow:var(--shadow)}

  @media(max-width:640px){ table{min-width:600px} .cards{grid-template-columns:repeat(2,1fr)} }
  @media print{ .topbar,.sidebar,.btn,.cards{display:none} table{min-width:0} }
</style>
</head>
<body>

<header class="topbar">
  <div class="brand"><div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#7c9af5)"></div>Warehouse Manager</div>
  <div class="controls">
    <select id="lang" class="control"><option value="id">Indonesia</option><option value="en">English</option></select>
    <div id="currentUser" class="muted">admin</div>
    <button id="menuToggle" class="btn ghost menu-toggle">â˜°</button>
  </div>
</header>

<aside class="sidebar" id="sidebar">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
    <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#7c9af5)"></div>
    <div style="font-weight:800">Warehouse</div>
  </div>

  <nav class="nav">
    <h6>Navigation</h6>
    <ul id="navList">
      <li><a href="#dashboard" data-view="dashboard" class="active">Dashboard</a></li>

      <li>
        <a href="#" data-toggle="sub">Operasional â–¾</a>
        <div class="submenu">
          <a href="#receipt" data-view="receipt">Penerimaan Barang</a>
          <a href="#transfer" data-view="transfer">Transfer ke Outlet</a>
        </div>
      </li>

      <li>
        <a href="#" data-toggle="sub">Master Data â–¾</a>
        <div class="submenu">
          <a href="#items" data-view="items">Master Barang</a>
          <a href="#outlets" data-view="outlets">Outlet</a>
        </div>
      </li>

      <li><a href="#reports" data-view="reports">Laporan</a></li>
      <li><a href="#settings" data-view="settings">Pengaturan</a></li>
    </ul>
  </nav>
  <div style="margin-top:18px;font-size:13px;color:#94b0ff">Â© <span id="year"></span> Warehouse</div>
</aside>

<main class="main" id="main" style="padding:18px">
  <!-- Dashboard -->
  <section id="view-dashboard" class="view">
    <div class="cards" id="widgets">
      <div class="card"><div class="label">Jenis Barang</div><div class="value" id="wItems">0</div></div>
      <div class="card"><div class="label">Total Stok</div><div class="value" id="wStock">0</div></div>
      <div class="card"><div class="label">Total Penerimaan</div><div class="value" id="wReceipts">0</div></div>
      <div class="card"><div class="label">Total Transfer</div><div class="value" id="wTransfers">0</div></div>
      <div class="card"><div class="label">Outlet</div><div class="value" id="wOutlets">0</div></div>
      <div class="card"><div class="label">Pengguna</div><div class="value" id="wUsers">1</div></div>
    </div>
    <div class="panel">
      <h3 style="margin:0">Aksi Cepat</h3>
      <div class="tools" style="margin-top:8px">
        <button class="btn" onclick="showView('receipt')">Penerimaan</button>
        <button class="btn" onclick="showView('transfer')">Transfer</button>
        <button class="btn ghost" onclick="showView('items')">Master Barang</button>
        <button class="btn ghost" onclick="showView('reports')">Laporan</button>
      </div>
    </div>
  </section>

  <!-- Receipt -->
  <section id="view-receipt" class="view hidden">
    <div class="panel">
      <h3>Penerimaan Barang</h3>
      <div class="grid-2" style="margin-top:10px">
        <div class="field"><label>Kode Barang</label><input id="rcpCode" placeholder="BRG-001"></div>
        <div class="field"><label>Nama Barang</label><input id="rcpName" placeholder="Cat Tembok 10L"></div>
        <div class="field"><label>Kuantitas</label><input id="rcpQty" type="number" min="1" value="1"></div>
        <div style="align-self:end"><button class="btn" onclick="addReceipt()">Tambah Penerimaan</button></div>
      </div>
    </div>

    <div class="panel">
      <h3>Daftar Inventori</h3>
      <div class="table-wrap">
        <table id="tblInventory"><thead><tr><th>No</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Transfer -->
  <section id="view-transfer" class="view hidden">
    <div class="panel">
      <h3>Transfer ke Outlet</h3>
      <div class="grid-2" style="margin-top:10px">
        <div class="field"><label>Kode Barang</label><input id="trfCode" placeholder="BRG-001"></div>
        <div class="field"><label>Nama Barang</label><input id="trfName" placeholder="Cat Tembok 10L"></div>
        <div class="field"><label>Kuantitas</label><input id="trfQty" type="number" min="1" value="1"></div>
        <div class="field"><label>Outlet</label><select id="trfOutlet"></select></div>
        <div style="align-self:end"><button class="btn" onclick="addTransfer()">Transfer</button></div>
      </div>
    </div>

    <div class="panel">
      <h3>Riwayat Transfer</h3>
      <div class="table-wrap">
        <table id="tblTransfers"><thead><tr><th>No</th><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Outlet</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Items -->
  <section id="view-items" class="view hidden">
    <div class="panel">
      <h3>Master Barang</h3>
      <div class="row" style="margin-top:10px;gap:8px">
        <div class="field" style="flex:1"><label>Kode</label><input id="itCode"></div>
        <div class="field" style="flex:2"><label>Nama</label><input id="itName"></div>
        <div style="align-self:end"><button class="btn" onclick="addItem()">Tambah Barang</button></div>
      </div>
    </div>

    <div class="panel">
      <h3>Daftar Barang</h3>
      <div class="table-wrap">
        <table id="tblItems"><thead><tr><th>No</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Outlets -->
  <section id="view-outlets" class="view hidden">
    <div class="panel">
      <h3>Outlet</h3>
      <div class="row" style="margin-top:10px;gap:8px">
        <div class="field" style="flex:1"><label>Kode</label><input id="outCode"></div>
        <div class="field" style="flex:2"><label>Nama</label><input id="outName"></div>
        <div style="align-self:end"><button class="btn" onclick="addOutlet()">Tambah Outlet</button></div>
      </div>
    </div>

    <div class="panel">
      <h3>Daftar Outlet</h3>
      <div class="table-wrap">
        <table id="tblOutlets"><thead><tr><th>No</th><th>Kode</th><th>Nama</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Reports -->
  <section id="view-reports" class="view hidden">
    <div class="panel">
      <h3>Laporan Transaksi</h3>
      <div class="row" style="align-items:center;gap:8px">
        <div class="field" style="flex:1"><label>Jenis</label>
          <select id="repType" class="control"><option value="all">Semua</option><option value="receipt">Penerimaan</option><option value="transfer">Transfer</option></select>
        </div>
        <div class="field" style="flex:2"><label>Pencarian</label><input id="repSearch" placeholder="Cari kode/nama/outlet..."></div>
        <div class="right tools">
          <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
          <button class="btn" onclick="window.print()">Print to PDF</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="table-wrap">
        <table id="tblReports"><thead><tr><th>No</th><th>Tanggal</th><th>Jenis</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Outlet</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="panel">
      <h3>Ringkasan Pengeluaran</h3>
      <div class="table-wrap">
        <table id="tblExpenses"><thead><tr><th>Outlet</th><th>Total Qty</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Settings -->
  <section id="view-settings" class="view hidden">
    <div class="panel">
      <h3>Pengaturan</h3>
      <div class="grid-2">
        <div class="field"><label>Username</label><input id="setUser" placeholder="admin"></div>
        <div class="field"><label>Password</label><input id="setPass" type="password"></div>
        <div class="row" style="align-items:center"><input type="checkbox" id="setWidgets"><label for="setWidgets" style="margin-left:8px">Tampilkan Widget</label></div>
        <div style="align-self:end"><button class="btn" onclick="saveSettings()">Simpan</button></div>
      </div>
      <div id="saveNote" class="muted" style="margin-top:10px"></div>
    </div>
  </section>
</main>

<!-- Modal (used for edit) -->
<div id="modal" class="modal-back hidden" role="dialog">
  <div class="modal">
    <h4 id="modalTitle">Edit</h4>
    <div id="modalBody"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn ghost" onclick="closeModal()">Batal</button>
      <button class="btn" id="modalSave">Simpan</button>
    </div>
  </div>
</div>

<script>
/* ===== data layer ===== */
const DB_KEY = 'whm.final.v1';
function dbInit(){
  if(!localStorage.getItem(DB_KEY)){
    const seed = {
      user:{username:'admin',password:'admin',showWidgets:true,lang:'id'},
      outlets:[{code:'OT-01',name:'Outlet Utama'}],
      inventory:[{code:'BRG-001',name:'Cat Tembok 10L',qty:12},{code:'BRG-002',name:'Amplas 400',qty:30}],
      receipts:[{id:uid(),date:new Date(Date.now()-86400000*2).toISOString(),code:'BRG-001',name:'Cat Tembok 10L',qty:12,note:'Seed'}],
      transfers:[{id:uid(),date:new Date().toISOString(),code:'BRG-002',name:'Amplas 400',qty:5,outlet:'OT-01',note:'Seed'}]
    };
    localStorage.setItem(DB_KEY,JSON.stringify(seed));
  }
}
function dbLoad(){ return JSON.parse(localStorage.getItem(DB_KEY)); }
function dbSave(d){ localStorage.setItem(DB_KEY,JSON.stringify(d)); }
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }

/* ===== UI helpers ===== */
function sel(id){ return document.getElementById(id); }
function showView(name){
  const views = ['dashboard','receipt','transfer','items','outlets','reports','settings'];
  views.forEach(v=> {
    const el = sel('view-'+v);
    if(!el) return;
    el.classList.toggle('hidden', v!==name);
    document.querySelectorAll('#navList [data-view="'+v+'"]').forEach(a=> a.classList.toggle('active', v===name));
  });
  if(name==='dashboard') refreshWidgets();
  if(name==='receipt') renderInventory();
  if(name==='transfer'){ renderTransfers(); populateOutletSelect(); }
  if(name==='items') renderItems();
  if(name==='outlets') renderOutlets();
  if(name==='reports'){ renderReports(); renderExpenses(); }
  location.hash = name;
}

/* ===== sidebar & nav behavior ===== */
const menuToggle = sel('menuToggle'), sidebar = sel('sidebar');
menuToggle.addEventListener('click', ()=> sidebar.classList.toggle('show'));
document.addEventListener('click', (e)=>{
  if(window.innerWidth < 900 && !sidebar.contains(e.target) && e.target !== menuToggle) sidebar.classList.remove('show');
});
document.querySelectorAll('[data-toggle="sub"]').forEach(btn=> btn.addEventListener('click', (e)=>{
  e.preventDefault(); btn.parentElement.classList.toggle('open');
}));
document.getElementById('navList').addEventListener('click', e=>{
  const a = e.target.closest('[data-view]'); if(!a) return;
  e.preventDefault(); if(window.innerWidth<900) sidebar.classList.remove('show'); showView(a.dataset.view);
});

/* ===== widgets ===== */
function refreshWidgets(){
  const db = dbLoad();
  sel('wItems').textContent = db.inventory.length;
  sel('wStock').textContent = db.inventory.reduce((s,i)=> s + Number(i.qty||0),0);
  sel('wReceipts').textContent = db.receipts.length;
  sel('wTransfers').textContent = db.transfers.length;
  sel('wOutlets').textContent = db.outlets.length;
  sel('wUsers').textContent = 1;
  sel('currentUser').textContent = 'ðŸ‘¤ ' + (db.user.username || 'admin');
  sel('setUser').value = db.user.username || '';
  sel('setWidgets').checked = db.user.showWidgets !== false;
  sel('lang').value = db.user.lang || 'id';
  sel('year').textContent = new Date().getFullYear();
}

/* ===== Inventory / Receipt ===== */
function renderInventory(){
  const tbody = sel('tblInventory').querySelector('tbody'); tbody.innerHTML = '';
  const db = dbLoad();
  db.inventory.forEach((it,i)=>{
    const tr = document.createElement('tr');
    const bc = it.qty <=5 ? 'b-danger' : (it.qty < 15 ? 'b-warn' : 'b-ok');
    tr.innerHTML = `<td>${i+1}</td><td>${it.code}</td><td>${it.name}</td><td><span class="badge ${bc}">${it.qty}</span></td>
      <td><div class="tools"><button class="btn ghost" onclick="openEditItem('${it.code}')">Edit</button><button class="btn secondary" onclick="deleteItem('${it.code}')">Hapus</button></div></td>`;
    tbody.appendChild(tr);
  });
}

function addReceipt(){
  const code = sel('rcpCode').value.trim(), name = sel('rcpName').value.trim(), qty = Number(sel('rcpQty').value) || 0;
  if(!code || !name || qty <= 0) return alert('Lengkapi data penerimaan.');
  const db = dbLoad();
  let item = db.inventory.find(x=>x.code===code);
  if(!item){ item = {code,name,qty}; db.inventory.push(item); } else { item.name = name; item.qty = Number(item.qty||0) + qty; }
  db.receipts.push({id:uid(),date:new Date().toISOString(),code,name,qty,note:'Receipt'});
  dbSave(db); sel('rcpCode').value=''; sel('rcpName').value=''; sel('rcpQty').value=1;
  renderInventory(); renderItems(); refreshWidgets();
}

/* ===== Transfers ===== */
function populateOutletSelect(){
  const selEl = sel('trfOutlet'); selEl.innerHTML = '';
  const db = dbLoad();
  db.outlets.forEach(o => { const opt = document.createElement('option'); opt.value=o.code; opt.textContent = `${o.code} â€” ${o.name}`; selEl.appendChild(opt); });
}

function addTransfer(){
  const code = sel('trfCode').value.trim(), name = sel('trfName').value.trim(), qty = Number(sel('trfQty').value)||0, outlet = sel('trfOutlet').value;
  if(!code||!name||qty<=0||!outlet) return alert('Lengkapi data transfer.');
  const db = dbLoad(); const inv = db.inventory.find(x=>x.code===code);
  if(!inv || Number(inv.qty) < qty) return alert('Stok tidak cukup atau barang belum ada.');
  inv.qty = Number(inv.qty) - qty;
  db.transfers.push({id:uid(),date:new Date().toISOString(),code,name,qty,outlet,note:'Transfer'});
  dbSave(db); renderTransfers(); renderInventory(); renderItems(); refreshWidgets();
}

function renderTransfers(){
  const tbody = sel('tblTransfers').querySelector('tbody'); tbody.innerHTML='';
  const db = dbLoad();
  db.transfers.slice().reverse().forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${new Date(t.date).toLocaleString()}</td><td>${t.code}</td><td>${t.name}</td><td>${t.qty}</td><td>${t.outlet || '-'}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===== Items CRUD ===== */
function renderItems(){
  const tbody = sel('tblItems').querySelector('tbody'); tbody.innerHTML='';
  const db = dbLoad();
  db.inventory.forEach((it,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${it.code}</td><td>${it.name}</td><td>${it.qty}</td>
      <td><div class="tools"><button class="btn ghost" onclick="openEditItem('${it.code}')">Edit</button><button class="btn secondary" onclick="deleteItem('${it.code}')">Hapus</button></div></td>`;
    tbody.appendChild(tr);
  });
}

function addItem(){
  const code = sel('itCode').value.trim(), name = sel('itName').value.trim();
  if(!code||!name) return alert('Isi kode dan nama.');
  const db = dbLoad(); if(db.inventory.some(x=>x.code===code)) return alert('Kode sudah ada.');
  db.inventory.push({code,name,qty:0}); dbSave(db); sel('itCode').value=''; sel('itName').value=''; renderItems(); renderInventory(); refreshWidgets();
}

function openEditItem(code){
  const db = dbLoad(); const item = db.inventory.find(x=>x.code===code);
  if(!item) return alert('Item tidak ditemukan.');
  showModal('Edit Barang', `
    <div class="field"><label>Kode</label><input id="editCode" value="${item.code}" disabled></div>
    <div class="field"><label>Nama</label><input id="editName" value="${escapeHtml(item.name)}"></div>
    <div class="field"><label>Qty</label><input id="editQty" type="number" value="${item.qty}"></div>
  `, ()=>{
    const db2 = dbLoad(); const it = db2.inventory.find(x=>x.code===code);
    it.name = sel('editName').value.trim(); it.qty = Number(sel('editQty').value)||0; dbSave(db2); closeModal(); renderItems(); renderInventory(); refreshWidgets();
  });
}

function deleteItem(code){
  if(!confirm('Hapus barang ini?')) return;
  const db = dbLoad(); db.inventory = db.inventory.filter(x=>x.code!==code); dbSave(db); renderItems(); renderInventory(); refreshWidgets();
}

/* ===== Outlets CRUD ===== */
function renderOutlets(){
  const tbody = sel('tblOutlets').querySelector('tbody'); tbody.innerHTML='';
  const db = dbLoad();
  db.outlets.forEach((o,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${o.code}</td><td>${o.name}</td><td><div class="tools"><button class="btn ghost" onclick="openEditOutlet('${o.code}')">Edit</button><button class="btn secondary" onclick="deleteOutlet('${o.code}')">Hapus</button></div></td>`;
    tbody.appendChild(tr);
  });
}

function addOutlet(){ const code = sel('outCode').value.trim(), name = sel('outName').value.trim(); if(!code||!name) return alert('Isi kode & nama'); const db = dbLoad(); if(db.outlets.some(x=>x.code===code)) return alert('Kode outlet sudah ada'); db.outlets.push({code,name}); dbSave(db); sel('outCode').value=''; sel('outName').value=''; renderOutlets(); refreshWidgets(); populateOutletSelect(); }
function openEditOutlet(code){ const db = dbLoad(); const o = db.outlets.find(x=>x.code===code); if(!o) return alert('Not found'); showModal('Edit Outlet', `<div class="field"><label>Kode</label><input id="editOutCode" value="${o.code}" disabled></div><div class="field"><label>Nama</label><input id="editOutName" value="${escapeHtml(o.name)}"></div>`, ()=>{ const db2=dbLoad(); const out = db2.outlets.find(x=>x.code===code); out.name = sel('editOutName').value.trim(); dbSave(db2); closeModal(); renderOutlets(); populateOutletSelect(); refreshWidgets(); }); }
function deleteOutlet(code){ if(!confirm('Hapus outlet?')) return; const db = dbLoad(); db.outlets = db.outlets.filter(x=>x.code!==code); dbSave(db); renderOutlets(); populateOutletSelect(); refreshWidgets(); }

/* ===== Reports ===== */
function collectRows(){ const db = dbLoad(); const r = db.receipts.map(x=>({...x,type:'receipt'})); const t = db.transfers.map(x=>({...x,type:'transfer'})); return [...r,...t].sort((a,b)=>new Date(b.date)-new Date(a.date)); }
function renderReports(){ const tbody = sel('tblReports').querySelector('tbody'); tbody.innerHTML=''; const rows = collectRows(); const tf = sel('repType').value; const q = sel('repSearch').value.trim().toLowerCase(); let out = rows.filter(r=> tf==='all' ? true : r.type===tf); if(q) out = out.filter(r=>(r.code+' '+r.name+' '+(r.outlet||'')).toLowerCase().includes(q)); out.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${new Date(r.date).toLocaleString()}</td><td>${r.type}</td><td>${r.code}</td><td>${r.name}</td><td>${r.qty}</td><td>${r.outlet||'-'}</td>`; tbody.appendChild(tr); }); }
function renderExpenses(){ const tbody = sel('tblExpenses').querySelector('tbody'); tbody.innerHTML=''; const db = dbLoad(); const agg = {}; db.transfers.forEach(t=> agg[t.outlet] = (agg[t.outlet]||0) + Number(t.qty)); db.outlets.forEach(o=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${o.code} â€” ${o.name}</td><td>${agg[o.code]||0}</td>`; tbody.appendChild(tr); }); }
function exportCSV(){ const rows = []; const headers = ['Tanggal','Jenis','Kode','Nama','Qty','Outlet']; rows.push(headers.join(',')); sel('tblReports').querySelectorAll('tbody tr').forEach(tr=>{ const cols = Array.from(tr.children).slice(1).map(td=>escapeCSV(td.textContent.trim())); rows.push(cols.join(',')); }); const blob = new Blob([rows.join('\n')],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='reports.csv'; a.click(); URL.revokeObjectURL(url); }
function escapeCSV(s){ return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

/* ===== Settings ===== */
function saveSettings(){ const db = dbLoad(); const u = sel('setUser').value.trim(); const p = sel('setPass').value; if(u) db.user.username = u; if(p) db.user.password = p; db.user.showWidgets = sel('setWidgets').checked; db.user.lang = sel('lang').value; dbSave(db); sel('saveNote').textContent = 'Disimpan.'; refreshWidgets(); }

/* ===== Modal helpers ===== */
function showModal(title, html, onSave){
  sel('modal').classList.remove('hidden'); sel('modalTitle').textContent = title; sel('modalBody').innerHTML = html; sel('modalSave').onclick = onSave;
}
function closeModal(){ sel('modal').classList.add('hidden'); sel('modalBody').innerHTML=''; sel('modalSave').onclick = null; }

/* ===== Utilities ===== */
function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }
function init(){
  dbInit(); refreshWidgets(); renderInventory(); renderItems(); renderOutlets(); renderTransfers(); renderReports(); renderExpenses(); populateOutletSelect();
  // routing
  const hash = (location.hash || '#dashboard').replace('#',''); showView(hash);
  sel('repType').addEventListener('change', renderReports); sel('repSearch').addEventListener('input', renderReports);
  sel('lang').addEventListener('change', (e)=>{ const db=dbLoad(); db.user.lang = e.target.value; dbSave(db); });
  // sidebar auto-close on small screens when a view clicked
  document.querySelectorAll('#navList [data-view]').forEach(a=> a.addEventListener('click', ()=>{ if(window.innerWidth<900) sidebar.classList.remove('show'); }));
}
window.addEventListener('load', init);
</script>

</body>
</html>