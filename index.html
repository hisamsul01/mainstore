function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sh, data = [];

  switch (e.parameter.type) {
    case "barang":
      sh = ss.getSheetByName("barang");
      data = sh.getDataRange().getValues();
      break;

    case "masuk":
      sh = ss.getSheetByName("masuk");
      data = sh.getDataRange().getValues();
      break;

    case "keluar":
      sh = ss.getSheetByName("keluar");
      data = sh.getDataRange().getValues();
      break;

    case "rekap":
      sh = ss.getSheetByName("rekap");
      data = sh.getDataRange().getValues();
      break;

    case "mutasi":
      sh = ss.getSheetByName("mutasi");
      data = sh.getDataRange().getValues();
      break;

    case "store":
      sh = ss.getSheetByName("store");
      data = sh.getDataRange().getValues();
      break;

    default:
      return ContentService.createTextOutput(
        JSON.stringify({ status: "error", message: "Unknown type" })
      ).setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(
    JSON.stringify({ status: "success", data })
  ).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    if (data.action === "addBarang") {
      const sh = ss.getSheetByName("barang");
      sh.appendRow([data.kode, data.nama, data.unit]);
      return success();
    }

    if (data.action === "addMasuk") {
      const sh = ss.getSheetByName("masuk");
      sh.appendRow([data.tanggal || new Date(), data.kode, data.nama, data.qty]);
      return success();
    }

    if (data.action === "addKeluar") {
      const sh = ss.getSheetByName("keluar");
      sh.appendRow([data.tanggal || new Date(), data.kode, data.nama, data.qty]);
      return success();
    }

    return error("Unknown action: " + data.action);
  } catch (err) {
    return error(err.message);
  }
}

function success() {
  return ContentService.createTextOutput(JSON.stringify({ status: "success" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function error(msg) {
  return ContentService.createTextOutput(
    JSON.stringify({ status: "error", message: msg })
  ).setMimeType(ContentService.MimeType.JSON);
}
