<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manajemen Inventory â€” WMS</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* sidebar like screenshot */
    .sidebar { background:#2f3a40; color: #f8fafc; min-height:100vh; }
    .sidebar button { text-align:left; }
    .active-menu { background:#1f2933; }
    /* table small */
    table th, table td { font-size: 0.95rem; }
  </style>
</head>
<body class="font-sans antialiased bg-gray-100">

  <div class="flex">

    <!-- SIDEBAR -->
    <aside class="sidebar w-64 p-6 hidden md:block">
      <h1 class="text-2xl font-bold mb-6">ðŸ“¦ Inventory</h1>
      <nav class="space-y-1 text-sm">
        <button data-page="dashboard" class="w-full px-3 py-2 rounded hover:bg-gray-800 active-menu">Dashboard</button>
        <button data-page="master" class="w-full px-3 py-2 rounded hover:bg-gray-800">Master Barang</button>
        <button data-page="stok-masuk" class="w-full px-3 py-2 rounded hover:bg-gray-800">Stok Masuk</button>
        <button data-page="stok-keluar" class="w-full px-3 py-2 rounded hover:bg-gray-800">Stok Keluar</button>
        <button data-page="rekap" class="w-full px-3 py-2 rounded hover:bg-gray-800">Rekap Stok</button>
        <button data-page="opname" class="w-full px-3 py-2 rounded hover:bg-gray-800">Stok Opname</button>
        <button data-page="laporan" class="w-full px-3 py-2 rounded hover:bg-gray-800">Laporan</button>
        <div class="border-t border-gray-700 mt-4 pt-4">
          <div class="text-xs text-gray-300 mb-1">Pengaturan</div>
          <button id="backupBtn" class="w-full px-3 py-2 rounded hover:bg-gray-800 text-xs">ðŸ’¾ Backup (download)</button>
          <label class="w-full block mt-2 text-xs">
            <span class="sr-only">Restore</span>
            <input id="restoreFile" type="file" accept="application/json" class="text-xs">
          </label>
          <button id="clearAll" class="w-full mt-2 px-3 py-2 rounded bg-red-600 hover:bg-red-700 text-white text-xs">Hapus Semua (local)</button>
        </div>
      </nav>
    </aside>

    <!-- MAIN -->
    <div class="flex-1 min-h-screen">

      <!-- TOPBAR -->
      <header class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
          <button id="mobileMenu" class="md:hidden px-2 py-1 bg-gray-200 rounded">â˜°</button>
          <div class="text-lg font-semibold">Sistem Manajemen Inventory</div>
          <div class="ml-auto flex items-center gap-3">
            <button id="addUserBtn" class="px-3 py-1 rounded bg-blue-600 text-white text-sm">Tambah User</button>

            <div class="border rounded flex overflow-hidden">
              <input id="globalSearch" placeholder="Cari barang..." class="px-3 py-1 w-64" />
              <button id="searchBtn" class="px-3 bg-blue-600 text-white">Cari</button>
            </div>

            <button id="exportExcel" class="px-3 py-1 rounded bg-emerald-500 text-white text-sm">Export Excel</button>
            <button id="exportPdf" class="px-3 py-1 rounded bg-yellow-400 text-sm">Export PDF</button>
          </div>
        </div>
      </header>

      <!-- CONTENT -->
      <main class="max-w-7xl mx-auto px-4 py-6">

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="page">
          <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="p-6 bg-white rounded shadow">
              <div class="text-sm text-gray-500">Barang Tersedia (unit)</div>
              <div id="stat-tersedia" class="text-3xl font-bold">0</div>
            </div>
            <div class="p-6 bg-white rounded shadow">
              <div class="text-sm text-gray-500">Barang Hampir Habis (jenis)</div>
              <div id="stat-hampir" class="text-3xl font-bold">0</div>
            </div>
            <div class="p-6 bg-white rounded shadow">
              <div class="text-sm text-gray-500">Barang Habis (jenis)</div>
              <div id="stat-habis" class="text-3xl font-bold">0</div>
            </div>
            <div class="p-6 bg-white rounded shadow">
              <div class="text-sm text-gray-500">Jumlah Store</div>
              <div id="stat-store" class="text-3xl font-bold">0</div>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-semibold mb-2">Grafik Stok Masuk vs Keluar</h3>
            <canvas id="dashboardChart" height="120"></canvas>
          </div>
        </section>

        <!-- MASTER BARANG -->
        <section id="page-master" class="page hidden">
          <div class="bg-white p-4 rounded shadow mb-4">
            <h3 class="font-semibold">Master Barang</h3>
            <p class="text-sm text-gray-500">Tambah / edit master barang. Stok awal diinput di sini.</p>

            <form id="formMaster" class="grid md:grid-cols-5 gap-3 mt-3">
              <input id="m_kode" placeholder="Kode Barang" class="border p-2 rounded" required />
              <input id="m_nama" placeholder="Nama Barang" class="border p-2 rounded" required />
              <input id="m_kategori" placeholder="Kategori" class="border p-2 rounded" />
              <input id="m_stokAwal" type="number" placeholder="Stok Awal" class="border p-2 rounded" min="0" />
              <button class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button>
            </form>
          </div>

          <div class="bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Daftar Master Barang</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full table-auto border-collapse">
                <thead>
                  <tr class="bg-gray-50">
                    <th class="p-2 border">Kode</th>
                    <th class="p-2 border">Nama</th>
                    <th class="p-2 border">Kategori</th>
                    <th class="p-2 border">Stok Awal</th>
                    <th class="p-2 border">Aksi</th>
                  </tr>
                </thead>
                <tbody id="masterTableBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- STOK MASUK -->
        <section id="page-stok-masuk" class="page hidden">
          <div class="bg-white p-4 rounded shadow mb-4">
            <h3 class="font-semibold">Stok Masuk</h3>
            <form id="formMasuk" class="grid md:grid-cols-5 gap-3 mt-3">
              <select id="ms_kode" class="border p-2 rounded" required></select>
              <input id="ms_nama" placeholder="Nama (otomatis)" class="border p-2 rounded bg-gray-50" readonly />
              <input id="ms_qty" type="number" placeholder="Qty" class="border p-2 rounded" min="1" required />
              <input id="ms_tgl" type="date" class="border p-2 rounded" required />
              <button class="bg-green-600 text-white px-4 py-2 rounded">Simpan Masuk</button>
            </form>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Log Masuk Terakhir</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full table-auto">
                <thead><tr class="bg-gray-50"><th class="p-2 border">Tanggal</th><th class="p-2 border">Kode</th><th class="p-2 border">Nama</th><th class="p-2 border">Qty</th></tr></thead>
                <tbody id="logMasukBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- STOK KELUAR -->
        <section id="page-stok-keluar" class="page hidden">
          <div class="bg-white p-4 rounded shadow mb-4">
            <h3 class="font-semibold">Stok Keluar</h3>
            <form id="formKeluar" class="grid md:grid-cols-6 gap-3 mt-3">
              <select id="sk_store" class="border p-2 rounded" required></select>
              <select id="sk_kode" class="border p-2 rounded" required></select>
              <input id="sk_nama" placeholder="Nama (otomatis)" class="border p-2 rounded bg-gray-50" readonly />
              <input id="sk_qty" type="number" placeholder="Qty" class="border p-2 rounded" min="1" required />
              <input id="sk_tgl" type="date" class="border p-2 rounded" required />
              <button class="bg-rose-600 text-white px-4 py-2 rounded">Simpan Keluar</button>
            </form>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Log Keluar Terakhir</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full table-auto">
                <thead><tr class="bg-gray-50"><th class="p-2 border">Tanggal</th><th class="p-2 border">Store</th><th class="p-2 border">Kode</th><th class="p-2 border">Nama</th><th class="p-2 border">Qty</th></tr></thead>
                <tbody id="logKeluarBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REKAP -->
        <section id="page-rekap" class="page hidden">
          <div class="bg-white p-4 rounded shadow mb-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">Rekap Stok</h3>
              <div class="flex gap-2">
                <button id="rekapExportExcel" class="px-3 py-1 bg-emerald-500 text-white rounded text-sm">Export Excel</button>
                <button id="rekapExportPdf" class="px-3 py-1 bg-yellow-400 rounded text-sm">Export PDF</button>
              </div>
            </div>

            <div class="mb-3">
              <input id="rekapSearch" placeholder="Cari kode atau nama..." class="w-full md:w-1/2 border p-2 rounded" />
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full table-auto border-collapse">
                <thead>
                  <tr class="bg-gray-50">
                    <th class="p-2 border">Kode Barang</th>
                    <th class="p-2 border">Nama Barang</th>
                    <th class="p-2 border">Kategori</th>
                    <th class="p-2 border">Stok Awal</th>
                    <th class="p-2 border">Stok Masuk</th>
                    <th class="p-2 border">Stok Keluar</th>
                    <th class="p-2 border">Stok Akhir</th>
                    <th class="p-2 border">Aksi</th>
                  </tr>
                </thead>
                <tbody id="rekapBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- STOK OPNAME -->
        <section id="page-opname" class="page hidden">
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Stok Opname</h3>
            <p class="text-sm text-gray-500 mb-3">Masukkan hasil hitung fisik dan bandingkan.</p>
            <div class="overflow-x-auto">
              <table class="min-w-full table-auto">
                <thead><tr class="bg-gray-50"><th class="p-2 border">Kode</th><th class="p-2 border">Nama</th><th class="p-2 border">Stok Sistem</th><th class="p-2 border">Hitung Fisik</th><th class="p-2 border">Aksi</th></tr></thead>
                <tbody id="opnameBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- LAPORAN -->
        <section id="page-laporan" class="page hidden">
          <div class="bg-white p-4 rounded shadow mb-4">
            <h3 class="font-semibold">Laporan & Analisis</h3>
            <p class="text-sm text-gray-500 mb-3">Pilih rentang untuk melihat analisis grafik.</p>
            <div class="grid md:grid-cols-3 gap-3 mb-3">
              <input id="lapFrom" type="date" class="border p-2 rounded" />
              <input id="lapTo" type="date" class="border p-2 rounded" />
              <button id="lapGenerate" class="bg-blue-600 text-white px-4 py-2 rounded">Tampilkan</button>
            </div>
            <div class="bg-white p-3 rounded shadow">
              <canvas id="lapChart" height="120"></canvas>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAL TAMBAH USER (sederhana) -->
  <div id="userModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
    <div class="bg-white p-5 rounded shadow w-96">
      <h4 class="font-semibold mb-2">Tambah User</h4>
      <form id="formUser" class="space-y-2">
        <input id="u_name" placeholder="Nama" class="w-full border p-2 rounded" required />
        <select id="u_role" class="w-full border p-2 rounded">
          <option>Admin</option>
          <option>Staff</option>
        </select>
        <div class="flex justify-end gap-2">
          <button type="button" id="closeUser" class="px-3 py-1 rounded border">Batal</button>
          <button class="px-3 py-1 rounded bg-blue-600 text-white">Simpan</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* =========================
   STATE & STORAGE
   ========================= */
const STORAGE_KEY = 'wms_data_v1';
let state = {
  master: [],       // {kode, nama, kategori, stokAwal}
  stores: [],       // {no, name}
  masuk: [],        // {tanggal,kode,nama,qty}
  keluar: [],       // {tanggal,kode,nama,qty,store}
  users: []         // {name,role}
};

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw) {
    try { state = JSON.parse(raw); } catch(e){ console.warn('parse err',e); }
  } else {
    // seed sample data for demo
    state.master = [
      {kode:'BRG001', nama:'Laptop Asus', kategori:'Elektronik', stokAwal:4},
      {kode:'BRG002', nama:'Mouse Logitech', kategori:'Aksesoris', stokAwal:21},
      {kode:'BRG003', nama:'Keyboard Mechanical', kategori:'Aksesoris', stokAwal:8},
      {kode:'BRG004', nama:'Monitor 24"', kategori:'Elektronik', stokAwal:4},
      {kode:'BRG005', nama:'Headset Gaming', kategori:'Aksesoris', stokAwal:10},
      {kode:'BRG006', nama:'Speaker PC', kategori:'Elektronik', stokAwal:16},
    ];
    state.stores = [{no:'S001',name:'Store Alpha'},{no:'S002',name:'Store Beta'}];
    state.masuk = [
      {tanggal:'2025-08-01', kode:'BRG001', nama:'Laptop Asus', qty:1},
      {tanggal:'2025-08-03', kode:'BRG002', nama:'Mouse Logitech', qty:2},
      {tanggal:'2025-08-05', kode:'BRG003', nama:'Keyboard Mechanical', qty:4},
    ];
    state.keluar = [
      {tanggal:'2025-08-10', kode:'BRG001', nama:'Laptop Asus', qty:1, store:'S001'},
      {tanggal:'2025-08-12', kode:'BRG004', nama:'Monitor 24\"', qty:4, store:'S002'},
    ];
    state.users = [{name:'Admin', role:'Admin'}];
    saveState();
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* =========================
   HELPERS
   ========================= */
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

function computeRekapFor(kode){
  const masterItem = state.master.find(m=>m.kode===kode);
  const stokAwal = masterItem ? Number(masterItem.stokAwal||0) : 0;
  const masukSum = state.masuk.filter(x=>x.kode===kode).reduce((s,it)=>s+Number(it.qty||0),0);
  const keluarSum = state.keluar.filter(x=>x.kode===kode).reduce((s,it)=>s+Number(it.qty||0),0);
  const stokAkhir = stokAwal + masukSum - keluarSum;
  return {stokAwal, masukSum, keluarSum, stokAkhir};
}

/* =========================
   RENDER / UI
   ========================= */

function renderMenuActive(page){
  $all('aside button[data-page]').forEach(btn=>{
    if(btn.getAttribute('data-page')===page) btn.classList.add('active-menu'); else btn.classList.remove('active-menu');
  });
}

/* show page by id */
function showPage(pageId){
  $all('.page').forEach(p=>p.classList.add('hidden'));
  $(`#page-${pageId}`).classList.remove('hidden');
  renderMenuActive(pageId);
  // run page-specific rendering
  if(pageId==='dashboard') renderDashboard();
  if(pageId==='master') renderMasterList();
  if(pageId==='stok-masuk') renderMasukUI();
  if(pageId==='stok-keluar') renderKeluarUI();
  if(pageId==='rekap') renderRekap();
  if(pageId==='opname') renderOpname();
  if(pageId==='laporan') renderLaporan();
}

/* DASHBOARD */
let dashboardChart;
function renderDashboard(){
  // stats
  const totalUnits = state.master.reduce((sum,m)=>{
    const r = computeRekapFor(m.kode);
    return sum + Number(r.stokAkhir||0);
  },0);
  const hampir = state.master.filter(m=>{
    const r = computeRekapFor(m.kode);
    return r.stokAkhir>0 && r.stokAkhir < 10;
  }).length;
  const habis = state.master.filter(m=> computeRekapFor(m.kode).stokAkhir <= 0 ).length;
  $('#stat-tersedia').innerText = totalUnits;
  $('#stat-hampir').innerText = hampir;
  $('#stat-habis').innerText = habis;
  $('#stat-store').innerText = state.stores.length;

  // chart masuk vs keluar per total qty
  const totalMasuk = state.masuk.reduce((s,x)=>s+Number(x.qty||0),0);
  const totalKeluar = state.keluar.reduce((s,x)=>s+Number(x.qty||0),0);
  const ctx = $('#dashboardChart').getContext('2d');
  if(dashboardChart) dashboardChart.destroy();
  dashboardChart = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['Masuk','Keluar'],
      datasets:[{data:[totalMasuk,totalKeluar], backgroundColor:['#10b981','#ef4444']}]
    },
    options:{responsive:true}
  });
}

/* MASTER */
function renderMasterList(){
  const tbody = $('#masterTableBody'); tbody.innerHTML = '';
  state.master.forEach((m, i)=>{
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="p-2 border">${m.kode}</td>
        <td class="p-2 border">${m.nama}</td>
        <td class="p-2 border">${m.kategori||''}</td>
        <td class="p-2 border">${m.stokAwal||0}</td>
        <td class="p-2 border">
          <button class="px-2 py-1 text-sm bg-yellow-300 rounded" onclick="editMaster(${i})">Edit</button>
          <button class="px-2 py-1 text-sm bg-red-500 text-white rounded" onclick="deleteMaster(${i})">Hapus</button>
        </td>
      </tr>
    `);
  });
}

/* MASUK */
function renderMasukUI(){
  // fill select kode list
  const sel = $('#ms_kode'); sel.innerHTML = '<option value="">-- pilih kode --</option>';
  state.master.forEach(m=> sel.innerHTML += `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`);
  // logs
  const tbody = $('#logMasukBody'); tbody.innerHTML = '';
  state.masuk.slice().reverse().forEach(m=>{
    tbody.insertAdjacentHTML('beforeend', `<tr><td class="p-2 border">${m.tanggal}</td><td class="p-2 border">${m.kode}</td><td class="p-2 border">${m.nama}</td><td class="p-2 border">${m.qty}</td></tr>`);
  });
}

/* KELUAR */
function renderKeluarUI(){
  // fill store select
  const selStore = $('#sk_store'); selStore.innerHTML = '<option value="">-- pilih store --</option>';
  state.stores.forEach(s=> selStore.innerHTML += `<option value="${s.no}">${s.no} - ${s.name}</option>`);
  // fill kode select
  const selKode = $('#sk_kode'); selKode.innerHTML = '<option value="">-- pilih kode --</option>';
  state.master.forEach(m=> selKode.innerHTML += `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`);
  // logs
  const tbody = $('#logKeluarBody'); tbody.innerHTML = '';
  state.keluar.slice().reverse().forEach(k=>{
    tbody.insertAdjacentHTML('beforeend', `<tr><td class="p-2 border">${k.tanggal}</td><td class="p-2 border">${k.store||''}</td><td class="p-2 border">${k.kode}</td><td class="p-2 border">${k.nama}</td><td class="p-2 border">${k.qty}</td></tr>`);
  });
}

/* REKAP */
function renderRekap(){
  const tbody = $('#rekapBody'); tbody.innerHTML = '';
  const q = $('#rekapSearch').value.trim().toLowerCase();
  state.master.forEach(m=>{
    if(q && !(m.kode.toLowerCase().includes(q) || m.nama.toLowerCase().includes(q))) return;
    const r = computeRekapFor(m.kode);
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="p-2 border">${m.kode}</td>
        <td class="p-2 border">${m.nama}</td>
        <td class="p-2 border">${m.kategori||''}</td>
        <td class="p-2 border text-center">${r.stokAwal}</td>
        <td class="p-2 border text-center">${r.masukSum}</td>
        <td class="p-2 border text-center">${r.keluarSum}</td>
        <td class="p-2 border text-center font-bold">${r.stokAkhir}</td>
        <td class="p-2 border text-center">
          <button class="px-2 py-1 text-sm bg-blue-500 text-white rounded" onclick="openEditMasterModal('${m.kode}')">Edit</button>
        </td>
      </tr>
    `.replace('r.keluarSum', r.keluarSum)); // ensure substitution (backward compatibility)
  });
  // fix for correct shown keluarSum because we used string.
  // We'll rebuild rows properly to avoid replace hack:
  // Re-render more robust:
  // (Instead, rebuild properly)
  // We'll re-do:
  tbody.innerHTML = '';
  state.master.forEach(m=>{
    if(q && !(m.kode.toLowerCase().includes(q) || m.nama.toLowerCase().includes(q))) return;
    const r = computeRekapFor(m.kode);
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="p-2 border">${m.kode}</td>
        <td class="p-2 border">${m.nama}</td>
        <td class="p-2 border">${m.kategori||''}</td>
        <td class="p-2 border text-center">${r.stokAwal}</td>
        <td class="p-2 border text-center">${r.masukSum}</td>
        <td class="p-2 border text-center">${r.keluarSum}</td>
        <td class="p-2 border text-center font-bold">${r.stokAkhir}</td>
        <td class="p-2 border text-center">
          <button class="px-2 py-1 text-sm bg-blue-500 text-white rounded" onclick="openEditMasterModal('${m.kode}')">Edit</button>
        </td>
      </tr>
    `);
  });
}

/* OPNAME */
function renderOpname(){
  const tbody = $('#opnameBody'); tbody.innerHTML = '';
  state.master.forEach((m,i)=>{
    const r = computeRekapFor(m.kode);
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="p-2 border">${m.kode}</td>
        <td class="p-2 border">${m.nama}</td>
        <td class="p-2 border text-center">${r.stokAkhir}</td>
        <td class="p-2 border text-center"><input data-idx="${i}" class="opname-input border p-1 w-24 text-center" type="number" min="0"/></td>
        <td class="p-2 border text-center"><button class="px-2 py-1 bg-green-600 text-white rounded" onclick="saveOpname(${i})">Simpan</button></td>
      </tr>
    `);
  });
}

/* LAPORAN */
let lapChart;
function renderLaporan(){
  // default: use totals
  const from = $('#lapFrom').value;
  const to = $('#lapTo').value;
  const masukFiltered = state.masuk.filter(m=> (!from || m.tanggal>=from) && (!to || m.tanggal<=to));
  const keluarFiltered = state.keluar.filter(k=> (!from || k.tanggal>=from) && (!to || k.tanggal<=to));
  // group by date sum
  const map = {};
  masukFiltered.forEach(m=> { map[m.tanggal] = map[m.tanggal] || {masuk:0,keluar:0}; map[m.tanggal].masuk += Number(m.qty||0); });
  keluarFiltered.forEach(k=> { map[k.tanggal] = map[k.tanggal] || {masuk:0,keluar:0}; map[k.tanggal].keluar += Number(k.qty||0); });
  const labels = Object.keys(map).sort();
  const dataMasuk = labels.map(d => map[d].masuk);
  const dataKeluar = labels.map(d => map[d].keluar);
  const ctx = $('#lapChart').getContext('2d');
  if(lapChart) lapChart.destroy();
  lapChart = new Chart(ctx, { type:'bar', data:{
    labels, datasets:[
      { label:'Masuk', data:dataMasuk, backgroundColor:'#10b981' },
      { label:'Keluar', data:dataKeluar, backgroundColor:'#ef4444' }
    ]
  }, options:{responsive:true, scales:{x:{ stacked:false }, y:{ beginAtZero:true }}}});
}

/* =========================
   EVENTS / ACTIONS
   ========================= */

document.addEventListener('DOMContentLoaded', ()=>{
  loadState();
  // attach menu buttons
  $all('aside button[data-page]').forEach(btn=>{
    btn.addEventListener('click', ()=> showPage(btn.getAttribute('data-page')));
  });
  // mobile menu open
  $('#mobileMenu').addEventListener('click', ()=> document.querySelector('aside').classList.toggle('hidden'));

  // default page
  showPage('rekap');

  // master form
  $('#formMaster').addEventListener('submit', (e)=>{
    e.preventDefault();
    const kode = $('#m_kode').value.trim();
    const nama = $('#m_nama').value.trim();
    const kategori = $('#m_kategori').value.trim();
    const stokAwal = Number($('#m_stokAwal').value || 0);
    if(!kode || !nama) return alert('lengkapi kode & nama');
    const exists = state.master.find(m=>m.kode===kode);
    if(exists) {
      if(!confirm('Kode sudah ada. Update data?')) return;
      exists.nama = nama; exists.kategori = kategori; exists.stokAwal = stokAwal;
    } else {
      state.master.push({kode,nama,kategori,stokAwal});
    }
    saveState(); renderMasterList(); renderMasukUI(); renderKeluarUI(); renderRekap(); renderOpname(); renderDashboard();
    e.target.reset();
    alert('Sukses menyimpan master barang');
  });

  // masuk form
  $('#formMasuk').addEventListener('submit', (e)=>{
    e.preventDefault();
    const kode = $('#ms_kode').value;
    const nama = $('#ms_nama').value;
    const qty = Number($('#ms_qty').value || 0);
    const tanggal = $('#ms_tgl').value;
    if(!kode || !tanggal || qty<=0) return alert('Lengkapi data masuk');
    state.masuk.push({tanggal,kode,nama,qty});
    saveState(); renderMasukUI(); renderRekap(); renderOpname(); renderDashboard(); alert('Stok masuk tersimpan');
    e.target.reset();
  });

  // when select kode, fill name
  $('#ms_kode').addEventListener('change', (e)=>{
    const kode = e.target.value;
    const m = state.master.find(x=>x.kode===kode);
    $('#ms_nama').value = m ? m.nama : '';
  });

  // keluar form
  $('#formKeluar').addEventListener('submit', (e)=>{
    e.preventDefault();
    const kode = $('#sk_kode').value;
    const nama = $('#sk_nama').value;
    const qty = Number($('#sk_qty').value || 0);
    const tanggal = $('#sk_tgl').value;
    const store = $('#sk_store').value;
    if(!kode || !tanggal || qty<=0 || !store) return alert('Lengkapi data keluar');
    // find master and check stock
    const r = computeRekapFor(kode);
    if(r.stokAkhir < qty) return alert('Stok tidak cukup!');
    state.keluar.push({tanggal,kode,nama,qty,store});
    saveState(); renderKeluarUI(); renderRekap(); renderOpname(); renderDashboard(); alert('Stok keluar tersimpan');
    e.target.reset();
  });

  $('#sk_kode').addEventListener('change', (e)=>{
    const kode = e.target.value;
    const m = state.master.find(x=>x.kode===kode);
    $('#sk_nama').value = m ? m.nama : '';
  });

  // store form not shown as separate page but create small helper to add store quickly:
  // We'll allow adding via prompt (or can create separate form). For now build small UI: add by double-click store list? We'll allow via console helper:
  // add store via modal? For simplicity, add keyboard shortcut:
  // But also add via restore/seed button - we already seeded sample stores.

  // Rekap search
  $('#rekapSearch').addEventListener('input', renderRekap);

  // Export excel (rekap)
  $('#rekapExportExcel').addEventListener('click', ()=>{
    const rows = state.master.map(m=>{
      const r = computeRekapFor(m.kode);
      return { Kode:m.kode, Nama:m.nama, Kategori:m.kategori||'', StokAwal:r.stokAwal, StokMasuk:r.masukSum, StokKeluar:r.keluarSum, StokAkhir:r.stokAkhir };
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Rekap Stok');
    XLSX.writeFile(wb, 'rekap_stok.xlsx');
  });

  // Export PDF (rekap) using jsPDF autoTable
  $('#rekapExportPdf').addEventListener('click', ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','pt','a4');
    const headers = [['Kode','Nama','Kategori','Stok Awal','Stok Masuk','Stok Keluar','Stok Akhir']];
    const body = state.master.map(m=>{
      const r = computeRekapFor(m.kode);
      return [m.kode, m.nama, m.kategori||'', r.stokAwal, r.masukSum, r.keluarSum, r.stokAkhir];
    });
    doc.text('Rekap Stok', 40, 40);
    doc.autoTable({ head: headers, body, startY: 70, styles:{fontSize:10} });
    doc.save('rekap_stok.pdf');
  });

  // global export buttons (general)
  $('#exportExcel').addEventListener('click', ()=>{
    const wb = XLSX.utils.book_new();
    const wsMaster = XLSX.utils.json_to_sheet(state.master);
    const wsMasuk = XLSX.utils.json_to_sheet(state.masuk);
    const wsKeluar = XLSX.utils.json_to_sheet(state.keluar);
    const wsStores = XLSX.utils.json_to_sheet(state.stores);
    XLSX.utils.book_append_sheet(wb, wsMaster, 'Master');
    XLSX.utils.book_append_sheet(wb, wsMasuk, 'Masuk');
    XLSX.utils.book_append_sheet(wb, wsKeluar, 'Keluar');
    XLSX.utils.book_append_sheet(wb, wsStores, 'Stores');
    XLSX.writeFile(wb, 'wms_export.xlsx');
  });

  $('#exportPdf').addEventListener('click', ()=>{
    // quick export summary PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('Ringkasan Inventory', 20, 20);
    const rows = state.master.map(m=> [m.kode, m.nama, computeRekapFor(m.kode).stokAkhir]);
    doc.autoTable({ head:[['Kode','Nama','Stok Akhir']], body:rows, startY:40 });
    doc.save('wms_summary.pdf');
  });

  // Rekap keyboard search button
  $('#searchBtn').addEventListener('click', ()=> { const q = $('#globalSearch').value.trim().toLowerCase(); $('#rekapSearch').value = q; showPage('rekap'); renderRekap(); });

  // Add user modal
  $('#addUserBtn').addEventListener('click', ()=> $('#userModal').classList.remove('hidden'));
  $('#closeUser').addEventListener('click', ()=> $('#userModal').classList.add('hidden'));
  $('#formUser').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = $('#u_name').value.trim();
    const role = $('#u_role').value;
    if(!name) return alert('Isi nama user');
    state.users.push({name,role});
    saveState();
    $('#userModal').classList.add('hidden');
    alert('User disimpan');
    e.target.reset();
  });

  // Backup / restore
  $('#backupBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'wms_backup.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#restoreFile').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=> {
      try {
        const parsed = JSON.parse(reader.result);
        if(confirm('Restore akan menggantikan data saat ini. Lanjutkan?')) {
          state = parsed; saveState(); alert('Restore berhasil'); location.reload();
        }
      } catch(err){ alert('File tidak valid'); }
    };
    reader.readAsText(file);
  });
  // clear all
  $('#clearAll').addEventListener('click', ()=>{
    if(confirm('Hapus semua data lokal?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
  });

  // Editing & delete master helpers
  window.editMaster = function(i){
    const m = state.master[i];
    const kode = prompt('Kode', m.kode); if(kode===null) return;
    const nama = prompt('Nama', m.nama); if(nama===null) return;
    const kategori = prompt('Kategori', m.kategori||''); if(kategori===null) return;
    const stokAwal = Number(prompt('Stok Awal', m.stokAwal)||0);
    m.kode = kode; m.nama = nama; m.kategori = kategori; m.stokAwal = stokAwal;
    saveState(); renderMasterList(); renderRekap(); renderMasukUI(); renderKeluarUI(); renderDashboard();
  };
  window.deleteMaster = function(i){
    if(!confirm('Hapus master barang?')) return;
    const kode = state.master[i].kode;
    state.master.splice(i,1);
    // optional: remove related masuk/keluar
    state.masuk = state.masuk.filter(x=>x.kode!==kode);
    state.keluar = state.keluar.filter(x=>x.kode!==kode);
    saveState(); renderMasterList(); renderRekap(); renderMasukUI(); renderKeluarUI(); renderDashboard();
  };

  // edit master modal by kode
  window.openEditMasterModal = function(kode){
    const idx = state.master.findIndex(m=>m.kode===kode);
    if(idx>=0) editMaster(idx);
  };

  // Opname save (adjust stokAwal to match physical count by updating stokAwal to hitung required)
  window.saveOpname = function(idx){
    const input = document.querySelector(`.opname-input[data-idx='${idx}']`);
    if(!input) return;
    const val = Number(input.value || 0);
    if(!confirm('Simpan hasil opname dan sesuaikan stok awal untuk mencocokkan sistem?')) return;
    // Current system stock:
    const kode = state.master[idx].kode;
    const r = computeRekapFor(kode);
    // To make system show `val` as current, adjust stokAwal by delta:
    const delta = val - r.stokAkhir;
    state.master[idx].stokAwal = Number(state.master[idx].stokAwal || 0) + delta;
    saveState(); renderOpname(); renderRekap(); renderDashboard();
    alert('Opname disimpan dan stok disesuaikan');
  };

  // stok masuk/keluar select change auto-fill name
  $('#ms_kode').addEventListener('change', (e)=> {
    const m = state.master.find(x=>x.kode===e.target.value); $('#ms_nama').value = m ? m.nama : '';
  });
  $('#sk_kode').addEventListener('change', (e)=> {
    const m = state.master.find(x=>x.kode===e.target.value); $('#sk_nama').value = m ? m.nama : '';
  });

  // Rekap search
  $('#rekapSearch').addEventListener('input', renderRekap);

  // General export buttons (topbar)
  $('#exportExcel').addEventListener('click', ()=> $('#exportExcel').click()); // handled above
  $('#exportPdf').addEventListener('click', ()=> $('#exportPdf').click());

  // Rekap export already bound above - we also attach general top exports to same actions:
  // Already done earlier.

  // laporan generate
  $('#lapGenerate').addEventListener('click', renderLaporan);

  // initial renders
  renderMasterList(); renderMasukUI(); renderKeluarUI(); renderRekap(); renderOpname(); renderDashboard();
});

/* =========================
   Utility: small fixes where needed
   ========================= */

// expose computeRekapFor to console for debug
window.computeRekapFor = computeRekapFor;
</script>
</body>
</html>
